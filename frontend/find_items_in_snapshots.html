<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Items in Screenshots finden</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: rgba(20, 15, 10, 0.95);
            border: 2px solid rgba(139, 69, 19, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1 { color: #ff8c00; }
        h2 { color: #ffb366; margin-top: 0; }
        .item { 
            background: rgba(0,0,0,0.5); 
            padding: 10px; 
            margin: 5px 0;
            border-left: 3px solid #ff8c00;
        }
        .item-name { color: #ffb366; font-weight: bold; }
        .item-details { color: #aaa; font-size: 0.9em; margin-left: 20px; }
        .snapshot-info { color: #888; font-size: 0.85em; margin-top: 5px; }
        .error { color: #ff6b6b; }
        .loading { color: #ffb366; }
        .stats { color: #4caf50; margin-top: 10px; }
        button {
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.9), rgba(255, 69, 0, 0.9));
            border: 2px solid rgba(255, 140, 0, 0.8);
            color: #fff;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
        }
        button:hover {
            background: linear-gradient(135deg, rgba(255, 140, 0, 1), rgba(255, 69, 0, 1));
        }
    </style>
</head>
<body>
    <h1>üîç Items in Screenshots finden</h1>
    <div style="margin-bottom: 20px;">
        <button onclick="findAllItemsInSnapshots(1)">Alle Items aus Screenshots f√ºr Bar-iton finden</button>
        <button onclick="compareWithCurrentItems(1)">Vergleiche mit aktuellen Items</button>
    </div>
    <div id="loading" class="loading"></div>
    <div id="content"></div>

    <script>
        async function findAllItemsInSnapshots(characterId) {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('content');
            
            loadingEl.textContent = 'Lade alle Screenshots √ºber SQL-API...';
            contentEl.innerHTML = '';
            
            try {
                // Hole alle Snapshots √ºber SQL-API
                const sqlResponse = await fetch('/backend/api/sql.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `SELECT id, character_id, snapshot_type, created_at, character_data FROM session_snapshots WHERE character_id = ${characterId} ORDER BY created_at DESC`
                    })
                });
                
                const sqlData = await sqlResponse.json();
                
                if (!sqlData.success || !sqlData.rows) {
                    throw new Error('Keine Screenshots gefunden oder SQL-Fehler');
                }
                
                const snapshots = sqlData.rows;
                let allItems = new Map(); // key -> {item, snapshots: []}
                
                // Durchsuche alle Snapshots
                for (const snapshotRow of snapshots) {
                    try {
                        const charData = JSON.parse(snapshotRow.character_data);
                        const snapshotInfo = `#${snapshotRow.id} (${snapshotRow.snapshot_type}, ${snapshotRow.created_at})`;
                        
                        extractItemsFromSnapshotData(charData, snapshotInfo, allItems);
                    } catch (e) {
                        console.warn('Fehler beim Parsen von Snapshot', snapshotRow.id, e);
                    }
                }
                
                loadingEl.textContent = `Gefunden: ${snapshots.length} Screenshot(s), ${allItems.size} eindeutige Items`;
                
                // Zeige alle gefundenen Items
                let html = '<div class="section">';
                html += `<h2>üì¶ Alle Items in Screenshots (${allItems.size} eindeutige Items aus ${snapshots.length} Screenshots)</h2>`;
                
                if (allItems.size === 0) {
                    html += '<p>Keine Items in Screenshots gefunden.</p>';
                } else {
                    // Sortiere nach Name
                    const sortedItems = Array.from(allItems.entries()).sort((a, b) => {
                        const nameA = a[1].item.name || '';
                        const nameB = b[1].item.name || '';
                        return nameA.localeCompare(nameB);
                    });
                    
                    for (const [itemKey, itemData] of sortedItems) {
                        const item = itemData.item;
                        html += '<div class="item">';
                        html += `<div class="item-name">${item.name || 'Unbekannt'}</div>`;
                        html += `<div class="item-details">`;
                        html += `Typ: ${item.type || 'N/A'}, Kategorie: ${item.category || 'N/A'}`;
                        if (item.id) html += `, ID: ${item.id}`;
                        if (item.damage) html += `, Schaden: ${item.damage}`;
                        if (item.toHit) html += `, Treffer: ${item.toHit}`;
                        if (item.ac !== null && item.ac !== undefined) html += `, AC: ${item.ac}`;
                        if (item.value) html += `, Wert: ${item.value}`;
                        if (item.quantity && item.quantity > 1) html += `, Anzahl: ${item.quantity}`;
                        html += `</div>`;
                        html += `<div class="snapshot-info">Gefunden in ${itemData.snapshots.length} Screenshot(s): ${itemData.snapshots.join(', ')}</div>`;
                        html += '</div>';
                    }
                }
                
                html += '</div>';
                contentEl.innerHTML = html;
                
            } catch (error) {
                loadingEl.innerHTML = `<span class="error">FEHLER: ${error.message}</span>`;
                console.error('Fehler:', error);
            }
        }
        
        function extractItemsFromSnapshotData(charData, snapshotInfo, allItemsMap) {
            // Equipment Items
            if (charData.equipment) {
                ['armor', 'mainhand', 'offhand'].forEach(slot => {
                    const item = charData.equipment[slot];
                    if (item && item.name) {
                        const key = `${item.name}_${item.type || 'unknown'}_${item.id || 'no-id'}`;
                        if (!allItemsMap.has(key)) {
                            allItemsMap.set(key, { item: JSON.parse(JSON.stringify(item)), snapshots: [] });
                        }
                        if (!allItemsMap.get(key).snapshots.includes(snapshotInfo)) {
                            allItemsMap.get(key).snapshots.push(snapshotInfo);
                        }
                    }
                });
            }
            
            // Inventory Items
            if (charData.inventory) {
                let items = [];
                if (Array.isArray(charData.inventory)) {
                    items = charData.inventory;
                } else {
                    items = [].concat(
                        charData.inventory.equipment || [],
                        charData.inventory.consumables || [],
                        charData.inventory.tools || [],
                        charData.inventory.treasure || []
                    );
                }
                
                items.forEach(item => {
                    if (item && item.name) {
                        const key = `${item.name}_${item.type || 'unknown'}_${item.id || 'no-id'}`;
                        if (!allItemsMap.has(key)) {
                            allItemsMap.set(key, { item: JSON.parse(JSON.stringify(item)), snapshots: [] });
                        }
                        if (!allItemsMap.get(key).snapshots.includes(snapshotInfo)) {
                            allItemsMap.get(key).snapshots.push(snapshotInfo);
                        }
                    }
                });
            }
        }
        
        
        async function compareWithCurrentItems(characterId) {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('content');
            
            loadingEl.textContent = 'Lade aktuelle Items und Screenshots...';
            contentEl.innerHTML = '';
            
            try {
                // Hole aktuelle Character-Daten
                const charResponse = await fetch(`/backend/api/characters.php?id=${characterId}`);
                const character = await charResponse.json();
                
                // Hole neuesten Screenshot
                const snapshotResponse = await fetch(`/backend/api/sessions.php?character_id=${characterId}&latest_snapshot=true`);
                let snapshot = null;
                if (snapshotResponse.ok) {
                    snapshot = await snapshotResponse.json();
                    if (snapshot.error) snapshot = null;
                }
                
                // Sammle aktuelle Items
                const currentItems = new Set();
                if (character.inventory) {
                    const items = Array.isArray(character.inventory) ? character.inventory : 
                        [].concat(
                            character.inventory.equipment || [],
                            character.inventory.consumables || [],
                            character.inventory.tools || [],
                            character.inventory.treasure || []
                        );
                    items.forEach(item => {
                        if (item.id) currentItems.add(item.id);
                        if (item.name) currentItems.add(`name:${item.name}`);
                    });
                }
                
                // Sammle Items aus Screenshot
                const snapshotItems = new Set();
                if (snapshot && snapshot.character_data) {
                    const charData = snapshot.character_data;
                    
                    // Equipment
                    if (charData.equipment) {
                        ['armor', 'mainhand', 'offhand'].forEach(slot => {
                            const item = charData.equipment[slot];
                            if (item) {
                                if (item.id) snapshotItems.add(item.id);
                                if (item.name) snapshotItems.add(`name:${item.name}`);
                            }
                        });
                    }
                    
                    // Inventory
                    if (charData.inventory) {
                        const items = Array.isArray(charData.inventory) ? charData.inventory : 
                            [].concat(
                                charData.inventory.equipment || [],
                                charData.inventory.consumables || [],
                                charData.inventory.tools || [],
                                charData.inventory.treasure || []
                            );
                        items.forEach(item => {
                            if (item.id) snapshotItems.add(item.id);
                            if (item.name) snapshotItems.add(`name:${item.name}`);
                        });
                    }
                }
                
                // Finde Unterschiede
                const onlyInSnapshot = [];
                const onlyInCurrent = [];
                
                snapshotItems.forEach(itemKey => {
                    if (!currentItems.has(itemKey)) {
                        onlyInSnapshot.push(itemKey);
                    }
                });
                
                currentItems.forEach(itemKey => {
                    if (!snapshotItems.has(itemKey)) {
                        onlyInCurrent.push(itemKey);
                    }
                });
                
                let html = '<div class="section">';
                html += '<h2>üìä Vergleich: Aktuelle Items vs. Screenshot</h2>';
                html += `<div class="stats">`;
                html += `Aktuelle Items: ${currentItems.size}<br>`;
                html += `Items im Screenshot: ${snapshotItems.size}<br>`;
                html += `Nur im Screenshot: ${onlyInSnapshot.length}<br>`;
                html += `Nur aktuell: ${onlyInCurrent.length}`;
                html += `</div>`;
                
                if (onlyInSnapshot.length > 0) {
                    html += '<h3 style="color: #ffb366; margin-top: 20px;">Items nur im Screenshot (nicht mehr aktuell):</h3>';
                    onlyInSnapshot.forEach(itemKey => {
                        html += `<div class="item">${itemKey}</div>`;
                    });
                }
                
                if (onlyInCurrent.length > 0) {
                    html += '<h3 style="color: #ffb366; margin-top: 20px;">Items nur aktuell (nicht im Screenshot):</h3>';
                    onlyInCurrent.forEach(itemKey => {
                        html += `<div class="item">${itemKey}</div>`;
                    });
                }
                
                html += '</div>';
                contentEl.innerHTML = html;
                loadingEl.textContent = '';
                
            } catch (error) {
                loadingEl.innerHTML = `<span class="error">FEHLER: ${error.message}</span>`;
                console.error('Fehler:', error);
            }
        }
    </script>
</body>
</html>

